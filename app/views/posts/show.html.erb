<%# --- SEO Meta Tags --- %>
<% content_for :title, @post.title %>
<% content_for :description, truncate(strip_tags(@post.body), length: 160) %>
<% set_meta_tags title: @post.title,
                description: truncate(strip_tags(@post.body), length: 160),
                canonical: post_url(@post),
                og: {
                  title: @post.title,
                  description: truncate(strip_tags(@post.body), length: 160),
                  type: 'article',
                  url: post_url(@post),
                  image: image_url('icon.png')
                },
                twitter: {
                  card: 'summary_large_image',
                  site: '@yourtwitter',
                  title: @post.title,
                  description: truncate(strip_tags(@post.body), length: 160),
                  image: image_url('icon.png')
                } %>
<%# --- Canonical Link --- %>
<link rel="canonical" href="<%= post_url(@post) %>" />

<%# --- JSON-LD Structured Data --- %>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "<%= j @post.title %>",
  "description": "<%= j truncate(strip_tags(@post.body), length: 160) %>",
  "author": {
    "@type": "Person",
    "name": "<%= j @post.user.email %>"
  },
  "datePublished": "<%= @post.created_at.iso8601 %>",
  "dateModified": "<%= @post.updated_at.iso8601 %>",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "<%= post_url(@post) %>"
  },
  "image": "<%= image_url('icon.png') %>"
}
</script>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <%= link_to root_path do %>
              <i class="fas fa-home me-1"></i>Home
            <% end %>
          </li>
          <li class="breadcrumb-item">
            <%= link_to posts_path do %>
              <i class="fas fa-blog me-1"></i>Posts
            <% end %>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            <%= truncate(@post.title, length: 30) %>
          </li>
        </ol>
      </nav>

      <article class="blog-post">
        <!-- Post Header -->
        <header class="mb-5">
          <div class="d-flex justify-content-between align-items-start mb-4">
            <h1 class="display-4 fw-bold text-primary"><%= @post.title %></h1>
            <span class="badge <%= @post.published? ? 'bg-success' : 'bg-warning' %> fs-6">
              <i class="fas fa-<%= @post.published? ? 'check-circle' : 'clock' %> me-1"></i>
              <%= @post.status.titleize %>
            </span>
          </div>
          
          <div class="post-meta mb-4">
            <div class="d-flex align-items-center mb-2">
              <i class="fas fa-user-circle text-primary me-2"></i>
              <span class="fw-medium"><%= @post.user.email %></span>
            </div>
            <div class="d-flex align-items-center text-muted">
              <i class="fas fa-clock me-2"></i>
              <span>Published <%= time_ago_in_words(@post.created_at) %> ago</span>
              <% if @post.updated_at != @post.created_at %>
                <span class="mx-2">â€¢</span>
                <span>Updated <%= time_ago_in_words(@post.updated_at) %> ago</span>
              <% end %>
            </div>
          </div>

          <!-- Action buttons for post owner -->
          <% if user_signed_in? && @post.user == current_user %>
            <div class="d-flex gap-3 mb-4">
              <%= link_to edit_post_path(@post), class: "btn btn-outline-primary" do %>
                <i class="fas fa-edit me-2"></i>Edit Post
              <% end %>
              <%= link_to post_path(@post), 
                          method: :delete, 
                          data: { confirm: "Are you sure you want to delete this post?" },
                          class: "btn btn-outline-danger" do %>
                <i class="fas fa-trash me-2"></i>Delete Post
              <% end %>
            </div>
          <% end %>
        </header>

        <!-- Post Content -->
        <div class="blog-post-content mb-5">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-5">
              <%= simple_format(@post.body, class: "lead lh-lg") %>
            </div>
          </div>
        </div>

        <!-- Post Footer -->
        <footer class="mb-5">
          <div class="d-flex justify-content-between align-items-center">
            <%= link_to posts_path, class: "btn btn-outline-secondary" do %>
              <i class="fas fa-arrow-left me-2"></i>Back to Posts
            <% end %>
            
            <div class="d-flex gap-2">
              <% if user_signed_in? %>
                <%= link_to dashboard_path, class: "btn btn-outline-primary" do %>
                  <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                <% end %>
              <% else %>
                <%= link_to new_user_session_path, class: "btn btn-primary" do %>
                  <i class="fas fa-sign-in-alt me-2"></i>Sign In
                <% end %>
              <% end %>
            </div>
          </div>
        </footer>
      </article>

      <!-- Comments Section -->
      <div class="comments-section">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-light">
            <h4 class="mb-0">
              <i class="fas fa-comments me-2"></i>
              Comments (<%= @post.comments_count %>)
            </h4>
          </div>
          <div class="card-body">
            <% if @post.comments.any? %>
              <% @post.comments.oldest.each do |comment| %>
                <div class="comment">
                  <div class="comment-header">
                    <span class="comment-author">
                      <i class="fas fa-user-circle me-2"></i>
                      <%= comment.user.email %>
                    </span>
                    <span class="comment-time">
                      <i class="fas fa-clock me-1"></i>
                      <%= time_ago_in_words(comment.created_at) %> ago
                    </span>
                  </div>
                  <div class="comment-body">
                    <%= simple_format(comment.body) %>
                  </div>
                  <% if user_signed_in? && comment.user == current_user %>
                    <div class="mt-3">
                      <%= button_to post_comment_path(@post, comment), 
                                  method: :delete, 
                                  class: "btn btn-outline-danger btn-sm", 
                                  data: { confirm: "Delete this comment?" } do %>
                        <i class="fas fa-trash me-1"></i>Delete
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-4">
                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No comments yet</h5>
                <p class="text-muted">Be the first to share your thoughts!</p>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Add Comment Form -->
        <% if user_signed_in? %>
          <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-plus me-2"></i>Add a Comment
              </h5>
            </div>
            <div class="card-body">
              <%= form_with(model: [@post, @comment], local: true) do |form| %>
                <div class="mb-3">
                  <%= form.label :body, class: "form-label fw-medium" do %>
                    <i class="fas fa-comment me-2"></i>Your Comment
                  <% end %>
                  <%= form.text_area :body, 
                      rows: 4, 
                      class: "form-control", 
                      placeholder: "Share your thoughts..." %>
                </div>
                <div class="d-flex justify-content-end">
                  <%= form.submit "Post Comment", class: "btn btn-primary" do %>
                    <i class="fas fa-paper-plane me-2"></i>Post Comment
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% else %>
          <div class="alert alert-info mt-4">
            <div class="d-flex align-items-center">
              <i class="fas fa-info-circle me-3 fa-2x"></i>
              <div>
                <h5 class="mb-1">Join the conversation!</h5>
                <p class="mb-0">
                  <%= link_to "Sign in", new_user_session_path, class: "text-decoration-none" %> to post a comment and share your thoughts.
                </p>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
