<%# --- SEO Meta Tags --- %>
<% content_for :title, @post.title %>
<% content_for :description, truncate(strip_tags(@post.body), length: 160) %>
<% set_meta_tags title: @post.title,
                description: truncate(strip_tags(@post.body), length: 160),
                canonical: post_url(@post),
                og: {
                  title: @post.title,
                  description: truncate(strip_tags(@post.body), length: 160),
                  type: 'article',
                  url: post_url(@post),
                  image: image_url('icon.png')
                },
                twitter: {
                  card: 'summary_large_image',
                  site: '@yourtwitter',
                  title: @post.title,
                  description: truncate(strip_tags(@post.body), length: 160),
                  image: image_url('icon.png')
                } %>
<%# --- Canonical Link --- %>
<link rel="canonical" href="<%= post_url(@post) %>" />

<%# --- JSON-LD Structured Data --- %>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "<%= j @post.title %>",
  "description": "<%= j truncate(strip_tags(@post.body), length: 160) %>",
  "author": {
    "@type": "Person",
    "name": "<%= j @post.user.email %>"
  },
  "datePublished": "<%= @post.created_at.iso8601 %>",
  "dateModified": "<%= @post.updated_at.iso8601 %>",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "<%= post_url(@post) %>"
  },
  "image": "<%= image_url('icon.png') %>"
}
</script>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <article class="blog-post">
        <!-- Post Header -->
        <header class="mb-4">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <h1 class="display-5 fw-bold"><%= @post.title %></h1>
            <span class="badge <%= @post.published? ? 'bg-success' : 'bg-warning' %> fs-6">
              <%= @post.status.titleize %>
            </span>
          </div>
          
          <div class="text-muted mb-3">
            <small>
              By <%= @post.user.email %> • 
              Published <%= time_ago_in_words(@post.created_at) %> ago
              <% if @post.updated_at != @post.created_at %>
                • Updated <%= time_ago_in_words(@post.updated_at) %> ago
              <% end %>
            </small>
          </div>

          <!-- Action buttons for post owner -->
          <% if user_signed_in? && @post.user == current_user %>
            <div class="mb-3">
              <%= link_to "Edit Post", edit_post_path(@post), class: "btn btn-outline-primary me-2" %>
              <%= link_to "Delete Post", post_path(@post), 
                          method: :delete, 
                          data: { confirm: "Are you sure you want to delete this post?" },
                          class: "btn btn-outline-danger" %>
            </div>
          <% end %>
        </header>

        <!-- Post Content -->
        <div class="blog-post-content">
          <%= simple_format(@post.body, class: "lead") %>
        </div>

        <!-- Post Footer -->
        <footer class="mt-5 pt-4 border-top">
          <div class="d-flex justify-content-between align-items-center">
            <%= link_to "← Back to Posts", posts_path, class: "btn btn-outline-secondary" %>
            
            <% if user_signed_in? %>
              <%= link_to "Dashboard", dashboard_path, class: "btn btn-outline-primary" %>
            <% else %>
              <%= link_to "Sign In", new_user_session_path, class: "btn btn-primary" %>
            <% end %>
          </div>
        </footer>
      </article>

      <!-- Comments Section -->
      <div class="mt-5">
        <h4>
          Comments (<%= @post.comments_count %>)
        </h4>
        <hr>
        <% @post.comments.oldest.each do |comment| %>
          <div class="mb-3 p-3 border rounded bg-light">
            <strong><%= comment.user.email %></strong>
            <span class="text-muted small">• <%= time_ago_in_words(comment.created_at) %> ago</span>
            <p class="mb-1"><%= simple_format(comment.body) %></p>
            <% if user_signed_in? && comment.user == current_user %>
              <%= button_to "Delete", post_comment_path(@post, comment), method: :delete, class: "btn btn-sm btn-outline-danger", data: { confirm: "Delete this comment?" } %>
            <% end %>
          </div>
        <% end %>
      </div>

      <% if user_signed_in? %>
        <div class="card mt-4">
          <div class="card-body">
            <%= form_with(model: [@post, Comment.new], local: true) do |form| %>
              <div class="mb-3">
                <%= form.label :body, "Add a comment", class: "form-label" %>
                <%= form.text_area :body, rows: 3, class: "form-control", placeholder: "Write your comment..." %>
              </div>
              <%= form.submit "Post Comment", class: "btn btn-primary" %>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="alert alert-info mt-4">
          <%= link_to "Sign in", new_user_session_path %> to post a comment.
        </div>
      <% end %>
    </div>
  </div>
</div>
